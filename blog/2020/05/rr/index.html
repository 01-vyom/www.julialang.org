<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv=x-ua-compatible  content="ie=edge"> <meta http-equiv=content-type  content="text/html; charset=utf-8" /> <meta name=author  content="Jeff Bezanson, Stefan Karpinski, Viral Shah, Alan Edelman, et al." /> <meta name=description  content="The official website for the Julia Language. Julia is a language that is fast, dynamic, easy to use, and open source. Click here to learn more."/> <meta property="og:title" content="The Julia Language"/> <meta property="og:image" content="/assets/images/julia-open-graph.png"/> <meta property="og:description" content="Official website for the Julia programming language"/> <link href="https://fonts.googleapis.com/css?family=Roboto:400,400i,500,500i,700,700i" rel=stylesheet > <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel=stylesheet > <link rel=stylesheet  href="/libs/bootstrap/bootstrap.min.css" /> <link rel=stylesheet  href="/css/app.css" /> <link rel=stylesheet  href="/css/fonts.css" /> <link rel=stylesheet  href="/css/franklin.css" /> <script async defer src="/libs/buttons.js"></script> <!-- --> <script type="application/javascript"> var doNotTrack = false; if (!doNotTrack) { window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date; ga('create', 'UA-28835595-1', 'auto'); ga('send', 'pageview'); } </script> <script async src='https://www.google-analytics.com/analytics.js'></script> <link rel=icon  href="/assets/infra/julia.ico"> <link rel=stylesheet  href="/libs/katex/katex.min.css"> <title>Coming in Julia 1.5: Time Traveling (Linux) Bug Reporting</title> <style> .container ul li p {margin-bottom: 0;} </style> <div class="container py-3 py-lg-0"> <nav class="navbar navbar-expand-lg navbar-light bg-light" id=main-menu > <a class=navbar-brand  href="/" id=logo > <img src="/assets/infra/logo.svg" height=55  width=85  alt="JuliaLang Logo"/> </a> <button class="navbar-toggler ml-auto hidden-sm-up float-xs-left" type=button  data-toggle=collapse  data-target="#navbarSupportedContent" aria-controls=navbarSupportedContent  aria-expanded=false  aria-label="Toggle navigation"> <span class=navbar-toggler-icon ></span> </button> <div class="collapse navbar-collapse" id=navbarSupportedContent > <ul class="navbar-nav mr-auto"> <li class="nav-item flex-md-fill text-md-center"> <a class=nav-link  href="/downloads/">Download</a> <li class="nav-item flex-md-fill text-md-center"> <a class=nav-link  href="https://docs.julialang.org">Documentation</a> <li class="nav-item active flex-md-fill text-md-center"> <a class=nav-link  href="/blog/">Blog</a> <li class="nav-item flex-md-fill text-md-center"> <a class=nav-link  href="/community/">Community</a> <li class="nav-item flex-md-fill text-md-center"> <a class=nav-link  href="/learning/">Learning</a> <li class="nav-item flex-md-fill text-md-center"> <a class=nav-link  href="/research/">Research</a> <li class="nav-item flex-md-fill text-md-center"> <a class=nav-link  href="/jsoc/">JSoC</a> <li class="nav-item donate flex-md-fill text-md-center"> <a class=github-button  href="https://github.com/sponsors/julialang" data-icon=octicon-heart  data-size=large  aria-label="Sponsor @julialang on GitHub">Sponsor</a> </ul> </div> </nav> </div> <br><br> <div class="container blog-title"> <h1>Coming in Julia 1.5: Time Traveling (Linux) Bug Reporting <a type="application/rss+xml" href="https://julialang.org/feed.xml"> <i style="color:#e2802f" class="fa fa-rss-square"></i> </a> </h1> <h3> <span style="font-weight: lighter;"> 2 May 2020 </span> | <span style="font-weight: bold;"></span> <span style="font-weight: bold;">Keno Fischer </span> </h3> </div> <div class=container > <link rel=stylesheet  type="text/css" href="/assets/blog/2020-05-02-rr/asciinema-player.css" /> <script src="/assets/blog/2020-05-02-rr/asciinema-player.js"></script> <style> @keyframes journey { from { transform: scale(1) } 10% { transform: translate(-10%,10%) scale(0.1) rotateZ(30deg); } 20% { transform: translate(-20%,-5%) scale(0.1) rotateZ(30deg); } 30% { transform: translate(-10%,-20%) scale(0.1) rotateZ(30deg); } 40% { transform: translate(-10%,-18%) scale(0.05) rotateZ(30deg); } 55% { transform: translate(-10%,-18%) scale(0.05) rotateZ(30deg); } 60% { transform: translate(-10%,-25%) scale(0.05) rotateZ(30deg); } 90% { transform: translate(10%,-25%) scale(0.1) rotateZ(30deg) rotateX(140deg); } } @keyframes fadeIn { 10% { opacity:1; } 90% { opacity:1; } } #player_main { position: absolute; left: 0; right: 0; margin: auto; z-index: 1; } #after_animation { margin-top: 700px; } #player_main.animated { animation-name: journey; animation-delay: 2s; animation-duration: 10s; } #arch_diagram { position: absolute; left: 0; right: 0; margin: auto; z-index: 0; opacity: 0; } #arch_diagram.animated { animation-name: fadeIn; animation-delay: 2s; animation-duration: 10s; } .hidden { display: none; } .control-bar { display: none; } #animation { height: 700px; } .container li > p { margin-bottom: 0 } </style> <div id=animation > <div id=player_main > <asciinema-player author="Keno Fischer" cols=100  id=record_player  rows=40  speed=1  theme=asciinema  title=Recording  src="/assets/blog/2020-05-02-rr/record.cast"> </asciinema-player> <asciinema-player author="Keno Fischer" cols=100  id=replay_player  class=hidden  rows=40  speed=1  theme=asciinema  title=Recording  src="/assets/blog/2020-05-02-rr/replay.cast"> </asciinema-player> </div> <image id=arch_diagram  src="/assets/blog/2020-05-02-rr/arch.svg"/> </div> <script> document.getElementById('record_player').addEventListener('ended', function(e) { document.getElementById('player_main').classList.add("animated"); document.getElementById('arch_diagram').classList.add("animated"); document.getElementById('player_main').addEventListener('animationend', () => { document.getElementById('record_player').classList.add("hidden"); document.getElementById('replay_player').classList.remove("hidden"); document.getElementById('replay_player').play(); }); }); </script> <p>The Julia project, like any large open source project, gets a large number of bug reports everyday. As the developers of the language, we try our best to be as responsive as possible and to triage, investigate and fix any bugs as quickly as possible. For some bugs, this is easy. If the bug report is well written and the problem is evident, getting it fixed is usually a quick affair. However, for a large number of issues, this is not as easy. There are several common reasons why bugs may go unaddressed for extended periods of time, for example:</p> <ol> <li><p>The bug may not reproduce deterministically, or maybe only reproduces on the reporter&#39;s machine &#40;sometimes known as a <a href="https://en.wikipedia.org/wiki/Heisenbug">Heisenbug</a>&#41;.</p> <li><p>The bug report may be incomplete as to the environment in which the bug occurs, making it hard to reproduce.</p> <li><p>The bug reporter may have seen the bug once, but not been entirely sure what caused it making it hard to give a reproducer and making the bug report largely unactionable.</p> <li><p>The bug may occur only in a large project that is hard to set up.</p> <li><p>The bug may require specialized expertise to diagnose &#40;e.g. a missing GC root&#41;, but the time commitment to reproduce it is too large for those who have the requisite expertise, since their time is in high demand.</p> </ol> <p>In addition, there are the bugs that never get filed, because the user may feel the effort to write a high-quality bug report is too high, since their specific setup would be too complicated to describe and reproduce. Such experiences are frustrating both for the users encountering them and for us, because we don&#39;t learn about them and sometimes only hear about it years later, when we get told that somebody gave up on their project in Julia because they encountered some crashing problem that they didn&#39;t feel qualified to reduce into a concise bug report and subsequently gave up on using Julia for their project. Lastly, we don&#39;t want or expect our users to be expert bug reporters. They are often working scientists who are good programmers, but may not have any background in software engineering. These are some of our most valuable users, and we want to make sure their bugs are addressed.</p> <p>For users who did encounter such particularly difficult problems, we have for a long time had one particular answer: If you can reproduce it on a linux machine and get us a trace from the <code>rr</code> tool <a href="https://rr-project.org/">https://rr-project.org/</a>, we can probably get it fixed for you very rapidly. For the uninitiated, <code>rr</code> is a Linux debugging tool originally written by Robert O&#39;Callahan at Mozilla. It is a tool known as a &quot;time traveling debugger&quot; or &quot;reverse execution engine&quot;. Essentially, <code>rr</code> splits reproducing bugs into a &quot;record&quot; and a &quot;replay&quot; phase. The record phase is performed by the bug reporter. During this phase, <code>rr</code> creates a perfect record of the execution, including the <em>bitwise exact</em> memory and register state after every instruction. This trace can then be analyzed during the replay phase &#40;which can be performed by a different developer on a different machine&#41;. Capabilities like these have long been imagined in academia, but it is extremely hard to achieve in a way that does not introduce large overheads or distort regular execution. <code>rr</code> is that first such tool that &#40;in our experience&#41; is performant enough to be used in the regular course of development. It is worth discussing how this is achieved &#40;and what limitations the approach has&#41;, but first let&#39;s take the capabilities for granted and take a look at the workflow it enables.</p> <p>In Julia 1.5, there is now a new command line flag <code>--bug-report&#61;rr</code> that will automatically create and upload an <code>rr</code> recording. An example usage is shown in the animation at the start of this post &#40;which just creates a deliberate crash by unsafely dereferencing a bad pointer&#41;. However to summarize:</p> <ol> <li><p>The bug reporter passes <code>--bug-report&#61;rr</code> to her julia instance and reproduces whatever bug they are attempting to reproduce.</p> <li><p>Once julia exits or crashes, the bug reporter is prompted to authorize an upload by clicking on a link &#40;GitHub-based authentication is used for abuse protection&#41;. She then gets back a link to include when filing a bug report against julia or some other package.</p> <li><p>Any developer can use the link to obtain the recording and analyze it on their own machine.</p> </ol> <p>In addition to this manual mechanism, we are also switching our linux CI systems to automatically create <code>rr</code> traces of any execution. That way, if a CI run fails, we are guaranteed to be able to debug it.</p> <p>If a bug report includes a link to an <code>rr</code> trace, no further reproduction instructions are required &#40;if the bug is something non-obvious like unexpected behavior, some comments on what the expected behavior was may still be helpful&#41;, since the <code>rr</code> trace is guaranteed to perfectly capture the environment the bug was reproduced in. This almost immediately knocks out all the common problems I started this post with. &quot;Works for me&quot; is no longer an available answer. If it&#39;s in the trace, it broke on somebody&#39;s machine and can be debugged. &quot;Heisenbug&quot;s are no longer an issue. If it was captured once in <code>rr</code>, it can always be debugged. It even solves the busy-expert problem, as it allows non-experts to help out with triage. If such a report does not contain an <code>rr</code> trace, any developer, and in particular non-experts can attempt to reproduce the bug and create one. Even if the expert is still required to do the final diagnosis, doing so from an <code>rr</code> trace is orders of magnitude faster than from a plain bug report.</p> <h1 id=chronomancy_for_dummies ><a href="#chronomancy_for_dummies">Chronomancy for dummies</a></h1> <p>A computer is fundamentally a deterministic machine. Given equivalent states as inputs, most instructions will produce a deterministic state as output. So where do all the subtle execution differences comes from that produce diverging executions and prevent bugs from reproducing? Well, the complete answer is complicated and has lots of details, but is roughly split up into:</p> <ol> <li><p>The input state is large. Probably the state of your entire hard drive and memory. That&#39;s at least <code>2^2^large</code> bits of state right there each of which could potentially cause a difference in execution. You really want to figure out what state is relevant, since <code>2^2^large</code> is probably too many bits to send somebody.</p> <li><p>Any input or other asynchronous events. This can mean user input, or data from the network &#40;via the NICs&#41; or other devices. It also means things like the timing of interrupts.</p> <li><p>Execution ordering and data races in multi-threaded executions.</p> </ol> <p>However, in theory if a tool was able to capture 100&#37; of the relevant state from these categories, it could repeated generate exactly the same memory image. This is not a novel idea, but the devil is in the detail. As already mentioned, just capturing everything is probably too large, if at all possible &#40;e.g. how do you capture interrupt timing - how do you even talk about time in this setting?&#41;.</p> <p>In other words, for some input state <span class=katex ><span class=katex-mathml ><math xmlns="https://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant=script >S</mi><mi mathvariant=script >i</mi></msub></mrow><annotation encoding="application/x-tex">\mathcal{S_{i}}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class=mord ><span class="mord mathcal" style="margin-right:0.075em;">S</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.075em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span>, the output state <span class=katex ><span class=katex-mathml ><math xmlns="https://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant=script >S</mi><mrow><mi mathvariant=script >i</mi><mo>+</mo><mn mathvariant=script >1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">\mathcal{S_{i+1}}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.891661em;vertical-align:-0.208331em;"></span><span class=mord ><span class=mord ><span class="mord mathcal" style="margin-right:0.075em;">S</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.075em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mbin mtight">+</span><span class="mord mathcal mtight">1</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.208331em;"><span></span></span></span></span></span></span></span></span></span></span> is determined by some pure, deterministic function <span class=katex ><span class=katex-mathml ><math xmlns="https://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant=script >I</mi><mrow><mi>i</mi><mi>p</mi><mo stretchy=false >(</mo><msub><mi mathvariant=script >S</mi><mi>i</mi></msub><mo stretchy=false >)</mo></mrow></msub></mrow><annotation encoding="application/x-tex">\mathcal{I}_{ip(\mathcal{S}_i)}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1.03853em;vertical-align:-0.3551999999999999em;"></span><span class=mord ><span class=mord ><span class="mord mathcal" style="margin-right:0.07382em;">I</span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.34480000000000005em;"><span style="top:-2.5198em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">p</span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mtight"><span class="mord mathcal mtight" style="margin-right:0.075em;">S</span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-right:0.07142857142857144em;"><span class=pstrut  style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.143em;"><span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.3551999999999999em;"><span></span></span></span></span></span></span></span></span></span>, corresponding to the instruction to be executed at time <span class=katex ><span class=katex-mathml ><math xmlns="https://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span></span></span></span>, or some asynchronous event <span class=katex ><span class=katex-mathml ><math xmlns="https://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant=script >A</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\mathcal{A}_i</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class=mord ><span class="mord mathcal">A</span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="https://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant=script >S</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>=</mo><mrow><mo fence=true >{</mo><mtable rowspacing=0.3599999999999999em  columnalign="left left" columnspacing=1em ><mtr><mtd><mstyle scriptlevel=0  displaystyle=false ><mrow><msub><mi mathvariant=script >A</mi><mi>i</mi></msub><mo stretchy=false >(</mo><msub><mi>S</mi><mi>i</mi></msub><mo stretchy=false >)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=false ><mrow><mtext>if an asynchronous even occured at time </mtext><mstyle scriptlevel=0  displaystyle=false ><mi>i</mi></mstyle></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=false ><msub><mi mathvariant=script >I</mi><mrow><mtext>ip</mtext><mo stretchy=false >(</mo><msub><mi mathvariant=script >S</mi><mi>i</mi></msub><mo stretchy=false >)</mo></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=false ><mtext>otherwise</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex"> \mathcal{S}_{i+1} = \begin{cases} \mathcal{A}_i(S_{i}) &amp; \text{if an asynchronous even occured at time $i$} \\ \mathcal{I}_{\text{ip}(\mathcal{S}_i)} &amp; \text{otherwise} \end{cases} </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.891661em;vertical-align:-0.208331em;"></span><span class=mord ><span class=mord ><span class="mord mathcal" style="margin-right:0.075em;">S</span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.208331em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:3.0000299999999998em;vertical-align:-1.25003em;"></span><span class=minner ><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class=mord ><span class=mtable ><span class=col-align-l ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.69em;"><span style="top:-3.69em;"><span class=pstrut  style="height:3.008em;"></span><span class=mord ><span class=mord ><span class=mord ><span class="mord mathcal">A</span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mopen >(</span><span class=mord ><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mclose >)</span></span></span><span style="top:-2.25em;"><span class=pstrut  style="height:3.008em;"></span><span class=mord ><span class=mord ><span class=mord ><span class="mord mathcal" style="margin-right:0.07382em;">I</span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.34480000000000005em;"><span style="top:-2.5198em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">ip</span></span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mtight"><span class="mord mathcal mtight" style="margin-right:0.075em;">S</span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-right:0.07142857142857144em;"><span class=pstrut  style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.143em;"><span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.3551999999999999em;"><span></span></span></span></span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:1.19em;"><span></span></span></span></span></span><span class=arraycolsep  style="width:1em;"></span><span class=col-align-l ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.69em;"><span style="top:-3.69em;"><span class=pstrut  style="height:3.008em;"></span><span class=mord ><span class="mord text"><span class=mord >if an asynchronous even occured at time </span><span class="mord mathdefault">i</span></span></span></span><span style="top:-2.25em;"><span class=pstrut  style="height:3.008em;"></span><span class=mord ><span class="mord text"><span class=mord >otherwise</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span> <p>Did that help? No? oh. Well, it made me feel better about my physics degree and also I&#39;ve been told it&#39;s not research until it has at least one equation in it, so there you go. Also, people worked really hard to get the equation rendering working, on this blog, so I better use it. Anyway, were were we?</p> <p>Ah yes, <code>rr</code> works by treating the kernel/userspace boundary as the determinism boundary. This has a lot of advantages. For one, the kernel isolates a lot of state. If a part of the disk state &#40;e.g. a file&#41; wasn&#39;t requested through the kernel, you can be guaranteed that it didn&#39;t affect the process state &#40;assuming the kernel works correctly of course&#41;. It abstracts over hardware details and provides a uniform interface to resources like the network. It also isolates processes from another, so if there is one process of interest &#40;e.g. julia&#41; only the activity relevant to it has to be recovered.</p> <p>Of course, there are some drawbacks as well. In order to function <code>rr</code> has to have an extremely precise model of the operation of the kernel and the ways in which it interacts with userspace. On Linux this interface is supposedly stable, but few applications put as stringent a constraint on that promise as <code>rr</code> does &#40;e.g. even a single bit difference can be problematic&#41;.</p> <p>The details here are quite involved, and I recommend reading Robert&#39;s <a href="https://arxiv.org/abs/1610.02144">technical report</a> for a deeper overview of some of <code>rr</code>&#39;s design points &#40;though even that only scratches the surface&#41;.</p> <p>One final thought for this section is the origin of the term &quot;time-traveling&quot; debugger. It stems from the mode of analysis that a system like this enables. In a traditional debugger, it is possible to execute one instruction at a time, and step from memory state to memory state in the forwards direction. Systems like <code>rr</code> allow the opposite during replay: Step backwards through the state of the system. Under the hood this is accomplished by playing forward from the beginning &#40;or more likely some intermediate checkpoint created for performance reasons&#41;, until the previous state is reached. However, to the end user, the illusion of going backwards in time is presented and an extremely useful mental model for debugging.</p> <h1 id=performance_considerations ><a href="#performance_considerations">Performance considerations</a></h1> <p>While the previous section described the operating principle of <code>rr</code>, it does not do justice to the reason why <code>rr</code> works so well. That reason is simple: performance. Overhead for recording of single threaded processes is generally below 2x, most often between 2&#37; and 50&#37; &#40;lower for purely numerical calculations, higher for workloads that interact with the OS&#41;. Recording multi-threaded processes is tougher. By default <code>rr</code> serializes execution of tasks that access the same shared memory. In generality this is required for correctness, since it is not possible to observe and record the interleaving of memory operations to shared memory spaces. However, there is hope. If the multi-threaded program is well-behaved &#40;or mostly well-behaved&#41; in that communication happens by message passing rather than shared memory, or if accesses to shared memory are explicitly synchronized in a recordable fashion, multi-threaded recording becomes possible. <code>rr</code> currently supports the former, if the messages are passed via operating system pipes. We are interested in techniques for the latter and there is some interesting academic work in this direction, but nothing close to production ready. A complete solution would probably combine compiler-based analysis of safe regions with dynamic enforcement of safety for regions where this cannot be proven by the compiler. However, that is for future work. For the moment, recording multi-threaded, shared-memory applications will likely incur overhead linear in the number of threads. It is thus a good idea to try and reproduce any issues at low core count.</p> <p>With that caveat in mind. Here is some real benchmark numbers of overhead for the julia test suite. The tests suite mostly uses message-passing based parallelism for running multiple tests in parallel. Only the <code>threads</code> test incurs the shared memory overhead penalty. Here are the measurements:</p> <p>&#91;data&#93;</p> <p>The total compressed size of a trace for a full run of the test suite &#40;about 30 minutes on 10 cores&#41; is about three gigabytes.</p> <h1 id=hardware_and_software_limitations ><a href="#hardware_and_software_limitations">Hardware and Software limitations</a></h1> <p>As was already mentioned, <code>rr</code> currently only works on Linux. However, there are more restrictions. At the moment only x86 chips with Intel microarchitecture are supported. <code>rr</code> relies on hardware performance counters to establish a precise and accurate notion of time for asynchronous events. If these hardware counters are not available or not precise enough, recording using <code>rr</code> will not work. We and others have investigated whether it would be possible to port rr to other architectures. To the best of my knowledge, the current thinking on this is as follows:</p> <ul> <li><p>For x86_64 with AMD Ryzen microarchitecture, it seems potentially possible, but the AMD performance counters are less accurate than those found on Intel chips. It may be possible to compensate for this in software, but the in-accuracies are ill-understood. Help in investigation is welcome &#40;<a href="https://github.com/mozilla/rr/issues/2034">issue</a>&#41;.</p> <li><p>For Aarch64, ll/sc-based atomics introduce additional problems, since various external factors &#40;interrupts, descheduling, etc.&#41; can be observed as sc aborts. With proper hardware support, this would be possible to work around, but such hardware support appeared to be too in-accurate on older generation Aarch64 chips and have been removed on recent generation ones. That said, Aarch64 microarchitectures are varied and as evidenced by the x86_64 experience, these things can vary quite a bit by microarchitecture. Investigation of the hardware capabilities of various Aarch64 microarchitectures would be very welcome &#40;<a href="https://github.com/mozilla/rr/issues/1373">issue</a>&#41;.</p> <li><p>We have looked into rr on POWER9, which is found in several large supercomputers that run julia jobs. POWER9 has similar issues to Aarch64 since it is also an ll/sc architecture, as well as supporting hardware transactional memory. In theory, we believe the hardware exists to compensate for these issues, but preliminary investigation suggests the hardware is not accurate enough to support <code>rr</code>. That said, I understand there&#39;s active discussions with IBM to determine whether this analysis is correct.</p> </ul> <p>One additional point of complication, is that it is quite easy for hypervisors &#40;such as those used by cloud vendors&#41; to interfere with the CPU capabilities required by <code>rr</code>. My understanding is that <code>rr</code> works fine on the latest generation of AWS machines, but not on GCP or Azure.</p> <p>Lastly, we shouldn&#39;t fail to mention GPUs. GPUs are heavily utilized by Julia users, but are currently not supported by <code>rr</code>. Changing this is tricky. GPUs often allow direct memory access between the device and the userspace program being recorded. If the interface to the GPU is known, this can definitely be mitigated, potentially at some performance cost, e.g. by double buffering. For GPUs with open source drivers, e.g. AMDGPU, there is active community interest in building such a solution. It is not an easy task, but I think it has a decent chance of succeeding, since open source drivers allow insight into exactly how the GPU works and when it will modify process memory. GPUs with proprietary drivers are a lot harder. For one, their interface to userspace is not necessarily known. Additionally, proprietary drivers tend to be a lot less well behaved than open source ones &#40;the linux kernel review process tends to filter out the most egregious behavior&#41;. For example, proprietary drivers have been observed to use the userspace stack for scratch space. For those GPUs in use by a large number of Julia users, we hope to work with the relevant vendors to bring this capability to their platforms, but it may be a long road.</p> <p>In summary, these new capabilities are currently only supported on Intel x86_64 chips. However, this is a bit of a chicken-and-egg problem. The hardware requirements are non-trivial, but not egregious. If the hardware vendors cared about this problem, they could definitely build hardware that enabled <code>rr</code> to work &#40;and if they really cared, they could build hardware assist features to make <code>rr</code> much faster&#41;, but without a significant user base of such features they have little incentive to care. I&#39;m hoping that by rolling out these capabilities widely, these incentives will start presenting themselves. Judging from the size of the community and discounting for those that use unsupported hardware or operating system, the number of users for whom this feature will be available like numbers in the hundreds of thousands. That isn&#39;t super large, by hardware vendor standards, but it isn&#39;t trivially small either. If any hardware vendor is interested in making this work, we&#39;d be happy to talk to you &#40;and as I mentioned, some of this is already in progress&#41;.</p> <h1 id=a_word_on_privacy ><a href="#a_word_on_privacy">A word on privacy</a></h1> <p>By its nature, an <code>rr</code> trace will contain any file touched by the process during its lifetime. In particular, this may contain things like your julia history, configuration files for your system, any secrets entered or read &#40;i.e. make sure to use ssh-agent if your reproducer involves using SSH for authentication&#41;, any private code you may be using, etc. We are investigating building tooling to help understand what&#39;s in the trace and anonymize parts of the trace that are potentially sensitive, but do not have long-ranging effects in the trace. We will also likely be disabling history by default if the <code>--bug-report</code> command line flag is passed. Nevertheless, please make sure to have the system administrator&#39;s permission before using the <code>--bug-report</code> feature. If you are not sure, we recommend creating the reproducer in a sanitized, isolated environment &#40;e.g. a docker container&#41;. Alternatively, while the <code>--bug-report</code> option creates a public upload by default, if you are user that has access to professional Julia support &#40;e.g. through your employer, supercomputing center or similar&#41;, you may be able to request a mechanism to share traces generated through this feature privately.</p> <h1 id=future_outlook ><a href="#future_outlook">Future outlook</a></h1> <p>Being able to replay the traces is only the beginning. I like to say that with <code>rr</code>, debugging becomes a data analysis problem, since any question you could possibly ask about the program is already contained in the data, it just becomes a question of extracting the answer. By default, <code>rr</code> drops you into GDB, but GDB is unlikely to be the correct frontend for such analysis. <code>rr</code>&#39;s original author Robert O&#39;Callahan now has a startup working on a next-generation frontend over at <a href="https://pernos.co/">https://pernos.co/</a> &#40;no affiliation, but his work made much of this possible, so a plug is the least I can do here&#41;. That said, Julia itself tends to be a pretty good tool for data analysis and I have some ideas what such a frontend may look like &#40;notebook style, with the ability to generate plots over the 2d time x space state of the recording&#41;. There&#39;s lots of cool things that can be done. To name just a few: Checking assertions after the fact, validating GC rooting accuracy after the fact, performance analysis, super precise coverage testing, etc. In fact, having the recording enables some analysis techniques that would be prohibitively expensive to do in real time, but that is a topic for another time.</p> <h2 id=conflict_of_interest_disclaimer_funding_acknowledgement ><a href="#conflict_of_interest_disclaimer_funding_acknowledgement">Conflict of Interest disclaimer / Funding Acknowledgement</a></h2> <p>Essentially all of the companies mentioned in this blog post have in the past provided financial or other support to the Julia project. In particular, Intel and IBM have in the past supported the Julia project financially to improve support for their respective architectures. Amazon, Google and Microsoft have provided cloud computing credits as well. Intel, Google, and Microsoft have also previously sponsored JuliaCon.</p> <p>This work was primarily funded by my employer, Julia Computing. Part of Julia Computing&#39;s open source work is funded by external grants. As such, part of this work was funded under a grant from the Moore Foundation, which is gratefully acknowledged.</p> <p>Part of this work was funded under a contract from Intel to improve the stability of multi-threading in Julia on Intel platforms. Additionally, where hardware bugs were encountered during this work, they were reported to the relevant vendor under existing funded contracts.</p> <p>Further, Julia Computing has <a href="https://juliacomputing.com/blog/2019/02/13/JuliaTeam-Vision.html">previously announced</a> that <code>rr</code> integration will likely be available in future commercial offerings. This is a separate piece of work and not a Julia Computing product. If you are interested in using these capabilities with a Julia Computing product, or under your Julia Computing support agreement, please contact your support representative.</p> <p>Lastly, your author discloses his self-interest. He spends too much time trying to get bug reports to reproduce under <code>rr</code> so they can be fixed, so if y&#39;all would do that for me, that&#39;d be swell.</div><br><br> <footer class="container-fluid footer-copy"> <div class=container > <div class=row > <ul id=menu  style="display:inline-block"> <a href="/project"><li class=footer-heading >About</a> <a href="/about/help"><li>Get Help</a> <a href="/community/#julia_github_groups"><li>Domains</a> <a href="/learning/getting-started/"><li>Getting Started</a> <a href="/research/#publications"><li>Publications</a> <a href="/research/#sponsors"><li>Sponsors</a> </ul> <ul id=menu  style="display:inline-block"> <a href="/downloads/"><li class=footer-heading >Downloads</a> <a href="/downloads/"><li>All Releases</a> <a href="https://github.com/JuliaLang/julia"><li>Source Code</a> <a href="/downloads/#current_stable_release"><li>Current Stable Release</a> <a href="/downloads/#long_term_support_release"><li>Longterm Support Release</a> <a href="/downloads/platform/#platform_specific_instructions_for_unofficial_binaries"><li>Unofficial Binaries</a> </ul> <ul id=menu  style="display:inline-block"> <a href="https://docs.julialang.org/en/v1/"><li class=footer-heading >Documentation</a> <a href="/community/#localization"><li>Non-English Docs</a> <a href="https://www.youtube.com/user/JuliaLanguage"><li>Video Talks</a> <a href="/learning/getting-started/"><li>Beginners Guide</a> <a href="https://docs.julialang.org/en/v1/devdocs/reflection/"><li>Developer Docs</a> <a href="https://docs.julialang.org/en/v1/manual/faq/"><li>FAQ</a> <a href="/learning/#books"><li>Julia Books</a> </ul> <ul id=menu  style="display:inline-block"> <a href="/community/"><li class=footer-heading >Community</a> <a href="/community/#2019_julia_user_and_developer_survey"><li>User/Developer Survey</a> <a href="/diversity/"><li>Diversity</a> <a href="/community/#official_channels"><li>Official Channels</a> <a href="/community/#other_channels"><li>Other Channels</a> <a href="/community/#events"><li>Events</a> </ul> <ul id=menu  style="display:inline-block"> <a href="https://github.com/JuliaLang/julia/blob/master/CONTRIBUTING.md"><li class=footer-heading >Contributing</a> <a href="https://github.com/JuliaLang/julia/issues"><li>Issue Tracker</a> <a href="https://github.com/JuliaLang/julia/security/policy"><li>Report a Security Issue</a> <a href="https://github.com/issues?q=is%3Aopen+is%3Aissue+language%3AJulia+label%3A%22help+wanted%22"><li>Help Wanted Issues</a> <a href="https://github.com/issues?q=is%3Aopen+is%3Aissue+language%3AJulia+label%3A%22good+first+issue%22+"><li>Good First Issue</a> <a href="https://docs.julialang.org/en/v1/devdocs/reflection/"><li>Dev Docs</a> </ul> </div> <div id=footer-bottom  class=row > <div class="col-md-10 py-2"> <p>Built with <a style="color: #7a95dd" href="https://franklinjl.org">Franklin.jl</a> - a native Julia package for building websites. We thank <a style="color: #7a95dd" href="https://www.fastly.com">Fastly</a> for their generous infrastructure support. <p>©2020 JuliaLang.org <a style="color: #7a95dd" href="https://github.com/JuliaLang/www.julialang.org/graphs/contributors">contributors</a>. The content on this website is made available under the <a style="color: #7a95dd" href="https://github.com/JuliaLang/www.julialang.org/blob/master/LICENSE.md">MIT license</a>. </div> <div class="col-md-2 py-2"> <a class=github-button  href="https://github.com/sponsors/julialang" data-icon=octicon-heart  data-size=large  aria-label="Sponsor @julialang on GitHub">Sponsor</a> </div> </div> </div> </footer> <script src="/libs/jquery/jquery.min.js"></script> <script src="/libs/bootstrap/bootstrap.min.js"></script> <script src="/libs/platform.js"></script>