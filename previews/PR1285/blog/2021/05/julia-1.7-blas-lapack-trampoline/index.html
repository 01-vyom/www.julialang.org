<!doctype html> <html lang=en > <meta charset=utf-8 > <meta name=viewport  content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv=x-ua-compatible  content="ie=edge"> <meta name=author  content="Jeff Bezanson, Stefan Karpinski, Viral Shah, Alan Edelman, et al."> <meta name=description  content="The official website for the Julia Language. Julia is a language that is fast, dynamic, easy to use, and open source. Click here to learn more."> <meta name=robots  content="max-image-preview:large"> <meta name="twitter:site:id" content=1237720952 > <meta name=google-site-verification  content=9VDSjBtchQj6PQYIVwugTPY7pVCfLYgvkXiRHjc_Bzw  /> <link rel=icon  href="/previews/PR1285/assets/infra/julia.ico"> <link rel=stylesheet  href="/previews/PR1285/libs/highlight/github.min.css"> <link rel=stylesheet  href="/previews/PR1285/libs/bootstrap/bootstrap.min.css"> <link rel=stylesheet  href="/previews/PR1285/css/app.css"> <link rel=stylesheet  href="/previews/PR1285/css/franklin.css"> <link rel=stylesheet  href="/previews/PR1285/css/fonts.css"> <link href="https://fonts.googleapis.com/css?family=Roboto:400,400i,500,500i,700,700i" rel=stylesheet > <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel=stylesheet > <script async defer src="/previews/PR1285/libs/buttons.js"></script> <script type="application/javascript"> var doNotTrack = false; if (!doNotTrack) { window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date; ga('create', 'UA-28835595-1', 'auto'); ga('send', 'pageview'); } </script> <script async src='https://www.google-analytics.com/analytics.js'></script> <title>BLAS and LAPACK trampolines in Julia 1.7</title> <style> .container ul li p {margin-bottom: 0;} </style> <style> .main { font-family: Georgia; } .main pre { margin-left: auto; margin-right: auto; } .main { width: 100%; font-size: 100%; } .main code { font-size: 90%; } .main pre code { font-size: 90%; } @media (min-width: 940px) { .main { width: 800px; } .container.blog-title { width: 800px;} } </style> <meta property="og:title" content="BLAS and LAPACK trampolines in Julia 1.7"> <meta property="og:description" content=""BLAS and LAPACK trampolines in Julia 1.7"> <meta property="og:image" content="/assets/images/julia-open-graph.png"> <div class="container py-3 py-lg-0"> <nav class="navbar navbar-expand-lg navbar-light bg-light" id=main-menu > <a class=navbar-brand  href="/previews/PR1285/"> <img src="/previews/PR1285/assets/infra/logo.svg" alt="JuliaLang Logo"> </a> <button class="navbar-toggler ml-auto hidden-sm-up float-xs-left" type=button  data-toggle=collapse  data-target="#navbarSupportedContent" aria-controls=navbarSupportedContent  aria-expanded=false  aria-label="Toggle navigation"> <span class=navbar-toggler-icon ></span> </button> <div class="collapse navbar-collapse" id=navbarSupportedContent > <ul class="navbar-nav mx-auto"> <li class="nav-item flex-md-fill text-md-center"> <a class=nav-link  href="/previews/PR1285/downloads/">Download</a> <li class="nav-item flex-md-fill text-md-center"> <a class=nav-link  href="https://docs.julialang.org">Documentation</a> <li class="nav-item active flex-md-fill text-md-center"> <a class=nav-link  href="/previews/PR1285/blog/">Blog</a> <li class="nav-item flex-md-fill text-md-center"> <a class=nav-link  href="/previews/PR1285/community/">Community</a> <li class="nav-item flex-md-fill text-md-center"> <a class=nav-link  href="/previews/PR1285/learning/">Learn</a> <li class="nav-item flex-md-fill text-md-center"> <a class=nav-link  href="/previews/PR1285/research/">Research</a> <li class="nav-item flex-md-fill text-md-center"> <a class=nav-link  href="/previews/PR1285/jsoc/">JSoC</a> </ul> <span class=navbar-right > <a class=github-button  href="https://github.com/sponsors/julialang" data-icon=octicon-heart  data-size=large  aria-label="Sponsor @julialang on GitHub">Sponsor</a> </span> </div> </nav> </div> <br><br> <div class="container blog-title"> <h1>BLAS and LAPACK trampolines in Julia 1.7 <a type="application/rss+xml" href="https://julialang.org/feed.xml"> <i class="fa fa-rss-square rss-icon"></i> </a> </h1> <h3> <span style="font-weight: lighter;"> 5 May 2021 </span> | <span style="font-weight: bold;"></span> <span style="font-weight: bold;">Elliot Saba, Viral Shah </span> </h3> </div> <a href="https://github.com/JuliaLang/www.julialang.org/blob/master/blog/2021/05/julia-1.7-blas-lapack-trampoline.md" title="Edit this page on GitHub" class=edit-float > </a> <div class="container main"><p>The BLAS and LAPACK libraries have been a corner stone of technical computing for at least 20 years now, if not more&#33; The APIs in BLAS and LAPACK have been so successful, that hardware vendors provide their own implementations of these APIs in order to extract the highest performance from their hardware. While Julia has always supported using your own BLAS, it has historically required either building Julia from source, or rebuilding the system image &#40;as was the case with MKL.jl&#41;.</p> <p>Julia 1.7 will ship with <a href="https://github.com/staticfloat/libblastrampoline">libblastrampoline</a> &#40;LBT&#41;. A famous aphorism of Butler Lampson goes: &quot;All problems in computer science can be solved by another level of indirection&quot;. Using <a href="https://en.wikipedia.org/wiki/Trampoline_&#40;computing&#41;">PLT trampolines</a> to provide a BLAS and LAPACK demuxing library. Essentially, going forward, Julia is linked against LBT. LBT in turn will call a user configured BLAS and LAPACK library. By default, Julia will ship with OpenBLAS, which LBT will forward calls to - but with a simple configuration, any other BLAS or LAPACK library can be used.</p> <p>In order to use <code>MKL</code> now, all a user has to do is <code>Pkg.add&#40;&quot;MKL&quot;&#41;</code> and <code>using MKL</code>, which will initialize LBT to forward all BLAS and LAPACK calls to MKL. This works on all the OSes where MKL is available &#40;and yes the MKL package automatically installs the <code>MKL_jll</code> package containing the MKL binaries&#41;. Here, we show how swapping in MKL provides faster matrix multiplication on a mac:</p> <pre><code class=language-julia >➜  ~ ./julia/julia
               _
   _       _ _&#40;_&#41;_     |  Documentation: https://docs.julialang.org
  &#40;_&#41;     | &#40;_&#41; &#40;_&#41;    |
   _ _   _| |_  __ _   |  Type &quot;?&quot; for help, &quot;&#93;?&quot; for Pkg help.
  | | | | | | |/ _&#96; |  |
  | | |_| | | | &#40;_| |  |  Version 1.7.0-DEV.971 &#40;2021-04-20&#41;
 _/ |\__&#39;_|_|_|\__&#39;_|  |  Commit 592db5886f* &#40;5 days old master&#41;
|__/                   |

julia&gt; peakflops&#40;&#41;
8.662873977420143e10

&#40;@v1.7&#41; pkg&gt; add MKL
    Updating registry at &#96;~/.julia/registries/General&#96;
    Updating git-repo &#96;https://github.com/JuliaRegistries/General.git&#96;
   Resolving package versions...
   Installed MKL ───────────── v0.4.0
   Installed PackageCompiler ─ v1.2.5
    Updating &#96;~/.julia/environments/v1.7/Project.toml&#96;
  &#91;33e6dc65&#93; &#43; MKL v0.4.0
    Updating &#96;~/.julia/environments/v1.7/Manifest.toml&#96;
  &#91;33e6dc65&#93; &#43; MKL v0.4.0
  &#91;9b87118b&#93; &#43; PackageCompiler v1.2.5
  &#91;1d5cc7b8&#93; &#43; IntelOpenMP_jll v2018.0.3&#43;2
  &#91;856f044c&#93; &#43; MKL_jll v2021.1.1&#43;1
  &#91;4af54fe1&#93; &#43; LazyArtifacts
    Building MKL → &#96;~/.julia/scratchspaces/44cfe95a-1eb2-52ea-b672-e2afdf69b78f/52c39a2b156743873c3919cd8ce83ac6075cc45f/build.log&#96;
Precompiling project...
  4 dependencies successfully precompiled in 45 seconds &#40;106 already precompiled&#41;

julia&gt; using MKL

julia&gt; peakflops&#40;&#41;
9.742296587986519e10</code></pre> <h2 id=basic_usage_of_lbt ><a href="#basic_usage_of_lbt">Basic usage of LBT</a></h2> <p>We use a linux example. Build <code>libblastrampoline.so</code>, then link your BLAS-using library against it instead of <code>libblas.so</code>. When <code>libblastrampoline</code> is loaded, it will inspect the <code>LBT_DEFAULT_LIBS</code> environment variable and attempt to forward BLAS calls made to it on to that library &#40;this can be a list of semicolon-separated libraries if your backing implementation is split across multiple libraries, such as in the case of separate <code>BLAS</code> and <code>LAPACK</code> libraries&#41;. At any time, you may call <code>lbt_forward&#40;libname, clear, verbose&#41;</code> to redirect forwarding to a new BLAS library. If you set <code>clear</code> to <code>1</code> it will clear out all previous mappings before setting new mappings, while if it is set to <code>0</code> it will leave symbols that do not exist within the given <code>libname</code> alone. This is used to implement layering of libraries, such as between a split BLAS and LAPACK library:</p> <pre><code class=language-julia >lbt_forward&#40;&quot;libblas.so&quot;, 1, 0&#41;;
lbt_forward&#40;&quot;liblapack.so&quot;, 0, 0&#41;;</code></pre> </div><br><br> <script src="/previews/PR1285/libs/highlight/highlight.pack.js"></script> <script>hljs.initHighlightingOnLoad();hljs.configure({tabReplace: ' '});</script> <footer class="container-fluid footer-copy"> <div class=container > <div class="row footrow"> <ul> <li><a href="/previews/PR1285/project">About</a> <li><a href="/previews/PR1285/about/help">Get Help</a> <li><a href="/previews/PR1285/blog/2019/02/julia-entities/">Governance</a> <li><a href="/previews/PR1285/research/#publications">Publications</a> <li><a href="/previews/PR1285/research/#sponsors">Sponsors</a> </ul> <ul> <li><a href="/previews/PR1285/downloads/">Downloads</a> <li><a href="/previews/PR1285/downloads/">All Releases</a> <li><a href="https://github.com/JuliaLang/julia">Source Code</a> <li><a href="/previews/PR1285/downloads/#current_stable_release">Current Stable Release</a> <li><a href="/previews/PR1285/downloads/#long_term_support_release">Longterm Support Release</a> <li><a href="https://status.julialang.org/">PkgServer Status</a> </ul> <ul> <li><a href="https://docs.julialang.org/en/v1/">Documentation</a> <li><a href="https://juliaacademy.com">JuliaAcademy</a> <li><a href="https://www.youtube.com/user/JuliaLanguage">YouTube</a> <li><a href="/previews/PR1285/learning/getting-started/">Getting Started</a> <li><a href="https://docs.julialang.org/en/v1/manual/faq/">FAQ</a> <li><a href="/previews/PR1285/learning/books">Books</a> </ul> <ul> <li><a href="/previews/PR1285/community/">Community</a> <li><a href="/previews/PR1285/community/standards/">Code of Conduct</a> <li><a href="/previews/PR1285/diversity/">Diversity</a> <li><a href="https://juliacon.org">JuliaCon</a> <li><a href="/previews/PR1285/community/#julia_user_and_developer_survey">User/Developer Survey</a> <li><a href="/previews/PR1285/shop/">Shop Merchandise</a> </ul> <ul> <li><a href="https://github.com/JuliaLang/julia/blob/master/CONTRIBUTING.md">Contributing</a> <li><a href="https://github.com/JuliaLang/julia/issues">Issue Tracker</a> <li><a href="https://github.com/JuliaLang/julia/security/policy">Report a Security Issue</a> <li><a href="https://github.com/issues?q=is%3Aopen+is%3Aissue+language%3AJulia+label%3A%22help+wanted%22">Help Wanted Issues</a> <li><a href="https://github.com/issues?q=is%3Aopen+is%3Aissue+language%3AJulia+label%3A%22good+first+issue%22+">Good First Issue</a> <li><a href="https://docs.julialang.org/en/v1/devdocs/reflection/">Dev Docs</a> </ul> </div> <div id=footer-bottom  class=row > <div class="col-md-10 py-2"> <p>Built with <a href="https://franklinjl.org">Franklin.jl</a> and the <a href="https://julialang.org">Julia Programming Language</a>. We thank <a href="https://www.fastly.com">Fastly</a> for their generous infrastructure support.</p> <p>©2021 JuliaLang.org <a href="https://github.com/JuliaLang/www.julialang.org/graphs/contributors">contributors</a>. The content on this website is made available under the <a href="https://github.com/JuliaLang/www.julialang.org/blob/master/LICENSE.md">MIT license</a>. </div> <div class="col-md-2 py-2"> <span class=float-sm-right > <a class=github-button  href="https://github.com/sponsors/julialang" data-icon=octicon-heart  data-size=large  aria-label="Sponsor @julialang on GitHub">Sponsor</a> </span> </div> </div> </div> </footer> <script src="/previews/PR1285/libs/jquery/jquery.min.js"></script> <script src="/previews/PR1285/libs/bootstrap/bootstrap.min.js"></script>